FROM node:15-alpine as build-ts

WORKDIR /usr/src/app

COPY . .

RUN yarn

FROM node:15-alpine

WORKDIR /usr/app

COPY --from=build-ts /usr/src/app/build build/
COPY --from=build-ts /usr/src/app/package.json /usr/src/app/yarn.lock ./

RUN yarn install --frozen-lockfile --production=true

ENV DEBUG instance:1
ARG GLOBAL_OFFSET_X=0
ENV GLOBAL_OFFSET_X=$GLOBAL_OFFSET_X
ARG GLOBAL_OFFSET_Y=0
ENV GLOBAL_OFFSET_Y=$GLOBAL_OFFSET_Y
ARG EXPLORE_CONCURRENCY=1
ENV EXPLORE_CONCURRENCY=$EXPLORE_CONCURRENCY
ARG EXPLORE_SIZE=16
ENV EXPLORE_SIZE=$EXPLORE_SIZE
ARG PRINT_STATS_TIME=60000
ENV PRINT_STATS_TIME=$PRINT_STATS_TIME
ARG STATS_INSTANCE_ID=1
ENV STATS_INSTANCE_ID=$STATS_INSTANCE_ID
ARG PQCASH_CONCURRENCY=1
ENV PQCASH_CONCURRENCY=$PQCASH_CONCURRENCY
ARG PRINT_DIGS_COUNT=100
ENV PRINT_DIGS_COUNT=$PRINT_DIGS_COUNT

# Show current folder structure in logs
RUN ls -al -R

CMD [ "node", "build/src/index.js" ]